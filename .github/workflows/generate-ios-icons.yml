name: Generate iOS Icons

on:
  workflow_dispatch:  # Manual trigger
  push:
    branches:
      - main
      - master
    paths:
      - 'app.config.js'
      - 'assets/**'
      - '.github/workflows/generate-ios-icons.yml'

jobs:
  generate-ios:
    runs-on: macos-latest
    permissions:
      contents: write  # Required to push commits
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Generate iOS project with icons
        run: |
          npx expo prebuild --platform ios --clean
          echo "iOS project generated successfully"

      - name: Verify icons were generated
        run: |
          # Check if icons directory exists (try common locations)
          if [ -d "ios/WaiverOnthego/Images.xcassets/AppIcon.appiconset" ]; then
            echo "✅ Icons directory exists at: ios/WaiverOnthego/Images.xcassets/AppIcon.appiconset"
            ls -la ios/WaiverOnthego/Images.xcassets/AppIcon.appiconset/
            echo "✅ Icon files found"
          elif [ -d "ios/projectmanagermobile/Images.xcassets/AppIcon.appiconset" ]; then
            echo "✅ Icons directory exists at: ios/projectmanagermobile/Images.xcassets/AppIcon.appiconset"
            ls -la ios/projectmanagermobile/Images.xcassets/AppIcon.appiconset/
            echo "✅ Icon files found"
          else
            echo "⚠️ Checking iOS folder structure..."
            find ios -name "AppIcon.appiconset" -type d 2>/dev/null || true
            echo "ℹ️ Icons may be generated but in a different location"
            echo "Continuing anyway - icons should be in the iOS project"
          fi

      - name: Commit and push iOS folder
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Check if there are changes to commit
          if [ -n "$(git status --porcelain ios 2>/dev/null)" ]; then
            git add ios/
            git commit -m "chore: generate iOS project with custom icons [skip ci]"
            git push
            echo "✅ iOS folder committed and pushed"
          else
            echo "ℹ️ No changes to iOS folder (may already be committed)"
            # Force add ios folder anyway to ensure it's tracked
            git add -f ios/ || true
            if [ -n "$(git diff --cached --quiet ios || echo 'changes')" ]; then
              git commit -m "chore: ensure iOS folder is tracked [skip ci]"
              git push
            fi
          fi

